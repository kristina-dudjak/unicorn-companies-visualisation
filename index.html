<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css">
    <script src="http://d3js.org/d3.v7.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="header">
        <img src="unicorn.jfif" width="40px" height="40px"></img>
        <span class="title">Unicorn companies</span>
    </div>
    <div class="container__main" height="1000">
        <svg class="container__main__svg" viewBox="50 50 1300 700" width="800" height="600"></svg>
        <div class="container__main__graphs" width="900">
            <canvas class="chart" width="700" height="300"></canvas>
            <div class="scrollable__container">
                <div class="scrollable__container__names">
                    <p>Names</p>
                </div>
                <div class="scrollable__container__industries">
                    <p>Industries</p>
                </div>
                <div class="scrollable__container__valuation">
                    <p>Valuation ($B)</p>
                </div>
                <div class="scrollable__container__raised">
                    <p>Total raised</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">

        var svg = d3.select(".container__main__svg");

        var g = svg.append("g");

        var projection = d3.geoEquirectangular()
            .center([-60, 40])
            .scale(200)
            ;

        var path = d3.geoPath()
            .projection(projection);

        var width = 2000;
        var height = 750;

        var companies;
        var countries;
        var companiesByCountry = [];

        await d3.json("unicorn_companies.json").then(function (data, error) {
            companies = data;
        });

        await d3.json("countries.json").then(function (data, error) {
            countries = data;
        });

        function getCompaniesByCountry(countryName) {
            return companiesByCountry.find(e => {
                return e.name == countryName;
            });
        }

        companies.forEach(e => {
            var country = getCompaniesByCountry(e.Country);
            if (!country) {
                country = {
                    name: e.Country,
                    count: 0
                };
                companiesByCountry.push(country);
            }

            if (e.Country == country.name) {
                country.count++;
            }
        })

        function getMax() {
            var max = 0;
            companiesByCountry.forEach(e => {
                if (e.count > max) {
                    max = e.count;
                }
            })
            return max;
        }

        var color = d3.scaleSqrt()
            .domain([0, getMax()])
            .range(["white", "green"]);

        const handleZoom = (e) => g.attr('transform', e.transform);

        const zoom = d3.zoom().on('zoom', handleZoom);

        d3.select('svg').call(zoom);

        d3.json("countries.json").then(function (world, error) {

            if (error) throw error;

            var data = topojson.feature(world, world.objects.countries);

            var countries = g.append("g")
                .selectAll("path.country")
                .data(data.features)
                .enter()
                .append("path")
                .attr("class", "country")
                .attr("id", function (d) { return d.id; })
                .attr("d", path)
                .style("fill", function (d) {
                    const companies = getCompaniesByCountry(d.properties.name);
                    if (companies) return color(companies.count);
                    else return "gray";
                })
                .style("stroke", "darkgray")
                .style("stroke-width", 1)
                .style("stroke-opacity", 1)
                .on("click", (e, d) => {
                    zoomCountry(e, d);
                    updateNumberOfCompaniesChart(e, d);
                    listCompanies(e, d);
                })
                ;

            const labels = [
                '2011',
                '2012',
                '2013',
                '2014',
                '2015',
                '2016',
                '2017',
                '2018',
                '2019',
                '2020',
                '2021',
                '2022'
            ];

            var chartDescription = 'Number of joined companies per year';

            var numbersPerYear = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

            var chartData = {
                labels: labels,
                datasets: [{
                    label: chartDescription,
                    backgroundColor: 'rgb(255, 99, 132)',
                    borderColor: 'rgb(255, 99, 132)',
                    data: numbersPerYear,
                }]
            };
            var config = {
                type: 'line',
                data: chartData,
                options: {}
            };
            var myChart = new Chart(
                document.getElementsByClassName("chart"),
                config
            );

            function listCompanies(e, d) {
                d3.select(".scrollable__container__names").selectAll("span").remove();
                d3.select(".scrollable__container__industries").selectAll("span").remove();
                d3.select(".scrollable__container__valuation").selectAll("span").remove();
                d3.select(".scrollable__container__raised").selectAll("span").remove();
                var companyNames = [];
                var companyIndustries = [];
                var companyValuations = [];
                var companyRaised = [];

                companies.forEach(element => {
                    if (element.Country == d.properties.name) {
                        companyNames.push(element.Company);
                        companyIndustries.push(element.Industry);
                        companyValuations.push(element.Valuation);
                        companyRaised.push(element.totalRaised);
                    }
                });

                d3.select(".scrollable__container__names").selectAll("span")
                    .data(companyNames)
                    .enter()
                    .append("span")
                    .text(d => (d))
                    .style("padding", "10px")
                    .style("border", "1px solid pink")
                    .on("mouseover", function (d) {
                        d3.select(this).transition()
                            .style('background', 'pink')
                            .style("cursor", "pointer");
                    })
                    .on("mouseout", function (d) {
                        d3.select(this).transition()
                            .style('background', 'white');
                    });

                d3.select(".scrollable__container__industries").selectAll("span")
                    .data(companyIndustries)
                    .enter()
                    .append("span")
                    .text(d => (d))
                    .style("padding", "10px")
                    .style("border", "1px solid pink")
                    .on("mouseover", function (d) {
                        d3.select(this).transition()
                            .style('background', 'pink')
                            .style("cursor", "pointer");
                    })
                    .on("mouseout", function (d) {
                        d3.select(this).transition()
                            .style('background', 'white');
                    });

                d3.select(".scrollable__container__valuation").selectAll("span")
                    .data(companyValuations)
                    .enter()
                    .append("span")
                    .text(d => (d))
                    .style("padding", "10px")
                    .style("border", "1px solid pink")
                    .on("mouseover", function (d) {
                        d3.select(this).transition()
                            .style('background', 'pink')
                            .style("cursor", "pointer");
                    })
                    .on("mouseout", function (d) {
                        d3.select(this).transition()
                            .style('background', 'white');
                    });

                d3.select(".scrollable__container__raised").selectAll("span")
                    .data(companyRaised)
                    .enter()
                    .append("span")
                    .text(d => (d))
                    .style("padding", "10px")
                    .style("border", "1px solid pink")
                    .on("mouseover", function (d) {
                        d3.select(this).transition()
                            .style('background', 'pink')
                            .style("cursor", "pointer");
                    })
                    .on("mouseout", function (d) {
                        d3.select(this).transition()
                            .style('background', 'white');
                    });
            }

            function updateNumberOfCompaniesChart(e, d) {

                numbersPerYear = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

                chartDescription = 'Number of joined companies in ' + d.properties.name + ' per year';

                for (let i = 0; i < labels.length; i++) {
                    companies.forEach(element => {
                        if (element.Country == d.properties.name && element.dateJoined.split("/").pop() == labels[i]) {
                            numbersPerYear[i] = numbersPerYear[i] + 1;
                        }
                    });
                }
                chartData.datasets[0].label = chartDescription;
                chartData.datasets[0].data = numbersPerYear;
                myChart.update();
            }

            function zoomCountry(e, d) {

                companies.forEach(element => {
                    if (element.Country == d.properties.name) {
                    }
                });
                console.log(d.properties.name);
                const [[x0, y0], [x1, y1]] = path.bounds(d);
                var scale_rate = Math.min(8, 0.9 / Math.max((x1 - x0) / width, (y1 - y0) / height));
                zoom.scaleBy(
                    g.transition().duration(750)
                        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + scale_rate + ")translate(" + -(x0 + x1) / 2 + "," + -(y0 + y1) / 2 + ")")
                        .transition()
                        .delay(2000)
                        .attr("transform", "translate(" + width + "," + height + ")scale(" + 1 + ")translate(" + width + "," + height + ")")
                    ,
                    1)
            }

            var legend = d3.select('body')
                .append('div')
                .style("margin", "0px 1200px 0px 0px")
                .style("background", "linear-gradient(to right, white, green)")
                .style("display", "flex")
                .style("justify-content", "space-between");

            var min = legend.append('span')
                .text('0')
                .style("padding", "0px 0px 0px 10px");

            var max = legend.append('span')
                .text(getMax())
                .style("padding", "0px 10px 0px 0px")
                ;
        });

    </script>
</body>

</html>