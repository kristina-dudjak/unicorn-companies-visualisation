<!DOCTYPE html>
<html>

<head>
    <script src="http://d3js.org/d3.v7.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
</head>

<body>
    <script type="module">

        d3.select('body').style("background", "gray");


        var width = 2000;
        var height = 750;

        var companies;
        var countries;
        var companiesByCountry = [];

        await d3.json("unicorn_companies.json").then(function (data, error) {
            companies = data;
        });

        await d3.json("countries.json").then(function (data, error) {
            countries = data;
        });

        function getCompaniesByCountry(countryName) {
            return companiesByCountry.find(e => {
                return e.name == countryName;
            });
        }

        companies.forEach(e => {
            var country = getCompaniesByCountry(e.Country);
            if (!country) {
                country = {
                    name: e.Country,
                    count: 0
                };
                companiesByCountry.push(country);
            }

            if (e.Country == country.name) {
                country.count++;
            }
        })

        function getMax() {
            var max = 0;
            companiesByCountry.forEach(e => {
                if (e.count > max) {
                    max = e.count;
                }
            })
            return max;
        }

        var color = d3.scaleSqrt()
            .domain([0, getMax()])
            .range(["white", "green"]);

        var svg = d3.select("body").append("svg")
            .attr("viewBox", [0, 0, width, height])
            .style("background", "white")
            ;

        var g = svg.append("g");

        var projection = d3.geoEquirectangular()
            .center([-60, 40])
            .scale(200)
            ;

        var path = d3.geoPath()
            .projection(projection);

        const handleZoom = (e) => g.attr('transform', e.transform);

        const zoom = d3.zoom().on('zoom', handleZoom);

        d3.select('svg').call(zoom);

        d3.json("countries.json").then(function (world, error) {

            if (error) throw error;

            var data = topojson.feature(world, world.objects.countries);

            var countries = g.append("g")
                .selectAll("path.country")
                .data(data.features)
                .enter()
                .append("path")
                .attr("class", "country")
                .attr("id", function (d) { return d.id; })
                .attr("d", path)
                .style("fill", function (d) {
                    const companies = getCompaniesByCountry(d.properties.name);
                    if (companies) return color(companies.count);
                    else return "gray";
                })
                .style("stroke", "darkgray")
                .style("stroke-width", 1)
                .style("stroke-opacity", 1)
                .on("click", zoomCountry)
                ;

            function zoomCountry(e, d) {

                companies.forEach(element => {
                    if (element.Country == d.properties.name) {
                        console.log(element);
                    }
                });
                console.log(d.properties.name);
                const [[x0, y0], [x1, y1]] = path.bounds(d);
                var scale_rate = Math.min(8, 0.9 / Math.max((x1 - x0) / width, (y1 - y0) / height));
                zoom.scaleBy(
                    g.transition().duration(750)
                        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + scale_rate + ")translate(" + -(x0 + x1) / 2 + "," + -(y0 + y1) / 2 + ")")
                        .transition()
                        .delay(2000)
                        .attr("transform", "translate(" + width + "," + height + ")scale(" + 1 + ")translate(" + width + "," + height + ")")
                    ,
                    1)
            }

            var legend = d3.select('body')
                .append('div')
                .style("margin", "0px 1200px 0px 0px")
                .style("background", "linear-gradient(to right, white, green)")
                .style("display", "flex")
                .style("justify-content", "space-between");

                var min = legend.append('span')
                .text('0')
                .style("padding", "0px 0px 0px 10px");
                
                var max = legend.append('span')
                .text(getMax())
                .style("padding", "0px 10px 0px 0px")
                ;

            
        });



    </script>
</body>

</html>